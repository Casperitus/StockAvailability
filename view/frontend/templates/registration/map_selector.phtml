<?php

/**
 * Map selector for registration form
 * @var \Madar\StockAvailability\Block\GoogleMaps $block
 */
$hyvaData = $block->prepareHyvaData();
?>

<div x-data="registrationMapComponent()" x-init="init()" class="registration-map-selector">
    <script>
        window.registrationMapData = <?= json_encode($hyvaData, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP); ?>;
    </script>

    <!-- Map Search Input -->
    <div class="mb-4">
        <label for="map-address-search" class="text-sm font-medium text-gray-700">
            <?= __('Search Address on Map') ?>
        </label>
        <div class="relative mt-1">
            <input
                type="text"
                id="map-address-search"
                x-ref="addressSearch"
                @input="onAddressInput($event)"
                placeholder="<?= $escaper->escapeHtmlAttr(__('Start typing to search...')) ?>"
                class="form-input w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base focus:outline-none focus:ring-paprika-500 focus:border-paprika-500">

            <!-- Use Current Location Button -->
            <button
                type="button"
                @click="useCurrentLocation()"
                class="absolute right-2 top-1/2 transform -translate-y-1/2 text-paprika-600 hover:text-paprika-700"
                title="<?= $escaper->escapeHtmlAttr(__('Use my current location')) ?>">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div
        id="registration-map-container"
        x-ref="mapContainer"
        class="w-full h-64 mb-4 border border-gray-300 rounded-md shadow-sm bg-gray-100"
        x-show="mapLoaded">
    </div>

    <!-- Hidden inputs for coordinates -->
    <input type="hidden" name="latitude" :value="latitude">
    <input type="hidden" name="longitude" :value="longitude">

    <!-- Selected Location Display -->
    <div x-show="hasSelectedLocation" class="p-3 bg-green-50 border border-green-200 rounded-md">
        <p class="text-sm text-green-800">
            <strong><?= __('Selected Location:') ?></strong>
            <span x-text="selectedAddress"></span>
        </p>
    </div>
</div>

<script>
    function registrationMapComponent() {
        return {
            map: null,
            marker: null,
            autocomplete: null,
            mapLoaded: false,
            latitude: <?= json_encode($hyvaData['latitude'] ?? 24.7136) ?>,
            longitude: <?= json_encode($hyvaData['longitude'] ?? 46.6753) ?>,
            selectedAddress: '',
            hasSelectedLocation: false,
            googleMapsApiLoaded: false,
            sourcesData: window.registrationMapData?.sourcesData || [],
            selectedBranchName: window.registrationMapData?.selected_branch_name || '',
            selectedBranchPhone: window.registrationMapData?.selected_branch_phone || '',
            selectedSourceCode: window.registrationMapData?.selected_source_code || null,
            street: '',
            streetLines: [],
            city: '',
            region: '',
            regionData: null,
            postcode: '',
            country: 'SA',
            district: '',
            isPersistingLocation: false,
            lastPersistedSignature: null,
            pendingSignature: null,

            init() {
                // Load Google Maps API
                if (!window.registrationMapData?.apiKey) {
                    console.error('[RegMap] Google Maps API key is missing');
                    return;
                }
                this.loadGoogleMapsApi();
            },
            loadGoogleMapsApi() {
                /* Wait for the global loader declared in google_maps.phtml */
                if (window._mapsApiReady) {
                    window._mapsApiReady.then(() => {
                        this.googleMapsApiLoaded = true;
                        this.initMap();
                    }).catch((e) => {
                        console.error('[RegMap] Google Maps failed to load', e);
                    });
                } else {
                    console.error('[RegMap] _mapsApiReady promise not found â€“ did you remove the global loader?');
                }
            },

            initMap() {
                const mapContainer = this.$refs.mapContainer;
                if (!mapContainer || !this.googleMapsApiLoaded) return;

                // Initialize map
                this.map = new google.maps.Map(mapContainer, {
                    center: {
                        lat: this.latitude,
                        lng: this.longitude
                    },
                    zoom: 12,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });

                // Add marker
                this.marker = new google.maps.Marker({
                    position: {
                        lat: this.latitude,
                        lng: this.longitude
                    },
                    map: this.map,
                    draggable: true
                });

                // Handle marker drag
                this.marker.addListener('dragend', (event) => {
                    this.updateLocation(event.latLng.lat(), event.latLng.lng());
                });

                // Initialize autocomplete
                this.initAutocomplete();

                this.mapLoaded = true;
                this.resolveBranchForLocation();
            },

            initAutocomplete() {
                const input = this.$refs.addressSearch;
                if (!input || !google.maps.places) return;

                this.autocomplete = new google.maps.places.Autocomplete(input, {
                    componentRestrictions: {
                        country: 'sa'
                    },
                    fields: ['address_components', 'formatted_address', 'geometry']
                });

                this.autocomplete.addListener('place_changed', () => {
                    const place = this.autocomplete.getPlace();
                    if (!place.geometry || !place.geometry.location) {
                        alert('<?= __('Please select a valid address from the dropdown') ?>');
                        return;
                    }

                    const location = place.geometry.location;
                    this.updateLocation(location.lat(), location.lng(), place.formatted_address);

                    // Center map on selected location
                    this.map.setCenter(location);
                    this.marker.setPosition(location);

                    // Parse address components to fill form fields
                    this.parseAddressComponents(place.address_components);
                });
            },

            updateLocation(lat, lng, address = null) {
                this.latitude = lat;
                this.longitude = lng;
                this.hasSelectedLocation = true;

                // Update parent Alpine component if exists
                if (this.$root.formData) {
                    this.$root.formData.latitude = lat;
                    this.$root.formData.longitude = lng;
                }

                // If no address provided, reverse geocode
                if (!address && google.maps.Geocoder) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({
                        location: {
                            lat,
                            lng
                        }
                    }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            this.selectedAddress = results[0].formatted_address;
                            this.parseAddressComponents(results[0].address_components);
                        }
                    });
                } else {
                    this.selectedAddress = address;
                }

                this.resolveBranchForLocation();
            },

            parseAddressComponents(components) {
                if (!components) return;

                const componentMap = {
                    street_number: '',
                    route: '',
                    locality: '',
                    administrative_area_level_1: '',
                    administrative_area_level_2: '',
                    postal_code: '',
                    country: '',
                    country_long: '',
                    sublocality: '',
                    sublocality_level_1: '',
                    sublocality_level_2: '',
                    neighborhood: '',
                    region_code: ''
                };

                components.forEach((component) => {
                    component.types.forEach((type) => {
                        switch (type) {
                            case 'street_number':
                            case 'route':
                            case 'locality':
                            case 'administrative_area_level_1':
                            case 'administrative_area_level_2':
                            case 'postal_code':
                            case 'sublocality':
                            case 'sublocality_level_1':
                            case 'sublocality_level_2':
                            case 'neighborhood':
                                componentMap[type] = component.long_name;
                                break;
                            case 'country':
                                componentMap.country = component.short_name || component.long_name;
                                componentMap.country_long = component.long_name;
                                break;
                        }

                        if (type === 'administrative_area_level_1' && component.short_name) {
                            componentMap.region_code = component.short_name;
                        }
                    });
                });

                const primaryStreet = [componentMap.street_number, componentMap.route]
                    .filter(Boolean)
                    .join(' ')
                    .trim();
                const districtCandidate =
                    componentMap.sublocality_level_1 ||
                    componentMap.sublocality_level_2 ||
                    componentMap.sublocality ||
                    componentMap.neighborhood ||
                    '';

                const streetLines = primaryStreet ? [primaryStreet] : [];
                if (districtCandidate) {
                    streetLines.push(districtCandidate);
                }

                this.streetLines = streetLines;
                this.street = streetLines.join(', ');
                this.district = districtCandidate;
                this.city = componentMap.locality || componentMap.administrative_area_level_2 || '';
                this.region = componentMap.administrative_area_level_1 || '';
                this.regionData = this.region
                    ? {
                          region: this.region,
                          ...(componentMap.region_code ? { region_code: componentMap.region_code } : {})
                      }
                    : null;
                this.postcode = componentMap.postal_code || '';
                this.country = componentMap.country || this.country;

                // Find and update the form fields by their IDs
                const streetInput = document.getElementById('street');
                const streetSecondInput = document.getElementById('street_2');
                const cityInput = document.getElementById('city');
                const regionInput = document.getElementById('region');
                const postcodeInput = document.getElementById('postcode');
                const countrySelect = document.querySelector('select[name="country_id"]');

                if (streetInput && primaryStreet) {
                    streetInput.value = primaryStreet;
                    streetInput.dispatchEvent(new Event('input', {
                        bubbles: true
                    }));
                }

                if (streetSecondInput && districtCandidate) {
                    streetSecondInput.value = districtCandidate;
                    streetSecondInput.dispatchEvent(new Event('input', {
                        bubbles: true
                    }));
                }

                if (cityInput && componentMap.locality) {
                    cityInput.value = componentMap.locality;
                    cityInput.dispatchEvent(new Event('input', {
                        bubbles: true
                    }));
                }

                if (regionInput && componentMap.administrative_area_level_1) {
                    regionInput.value = componentMap.administrative_area_level_1;
                    regionInput.dispatchEvent(new Event('input', {
                        bubbles: true
                    }));
                }

                if (postcodeInput && componentMap.postal_code) {
                    postcodeInput.value = componentMap.postal_code;
                    postcodeInput.dispatchEvent(new Event('input', {
                        bubbles: true
                    }));
                }

                if (countrySelect && componentMap.country) {
                    countrySelect.value = componentMap.country;
                    countrySelect.dispatchEvent(new Event('change', {
                        bubbles: true
                    }));
                }

                // Also dispatch a custom event that the parent component can listen to
                window.dispatchEvent(new CustomEvent('map-address-selected', {
                    detail: {
                        street: primaryStreet,
                        street_lines: streetLines,
                        district: districtCandidate,
                        city: componentMap.locality,
                        region: componentMap.administrative_area_level_1,
                        postcode: componentMap.postal_code,
                        country: componentMap.country,
                        latitude: this.latitude,
                        longitude: this.longitude
                    }
                }));

            },

            resolveBranchForLocation() {
                const branch = this.findNearestBranch(this.latitude, this.longitude, this.sourcesData);

                if (branch) {
                    this.selectedBranchName = branch.source_name;
                    this.selectedBranchPhone = branch.phone;
                    this.selectedSourceCode = branch.source_code;
                } else {
                    this.selectedBranchName = '';
                    this.selectedBranchPhone = '';
                    this.selectedSourceCode = null;
                }
            },

            async persistLocationSelection() {
                const payload = this.buildLocationPayload();
                const signature = JSON.stringify(payload);

                if (this.lastPersistedSignature === signature) {
                    return;
                }

                if (this.isPersistingLocation) {
                    this.pendingSignature = signature;
                    return;
                }

                this.pendingSignature = null;

                this.isPersistingLocation = true;

                try {
                    const response = await fetch('/stockavailability/branch/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: signature,
                        credentials: 'same-origin'
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to persist location selection');
                    }

                    this.lastPersistedSignature = signature;
                    this.pendingSignature = null;

                    window.dispatchEvent(new CustomEvent('madar:location-updated', {
                        detail: data
                    }));
                } catch (error) {
                    console.error('[RegMap] Unable to persist location selection', error);
                } finally {
                    this.isPersistingLocation = false;

                    if (
                        this.pendingSignature &&
                        this.pendingSignature !== this.lastPersistedSignature
                    ) {
                        this.pendingSignature = null;
                        this.persistLocationSelection();
                    }
                }
            },

            buildLocationPayload() {
                const payload = {
                    selected_source_code: this.selectedSourceCode,
                    selected_branch_name: this.selectedBranchName,
                    selected_branch_phone: this.selectedBranchPhone,
                    customer_latitude: this.latitude,
                    customer_longitude: this.longitude
                };

                const streetLines = Array.isArray(this.streetLines)
                    ? [...this.streetLines]
                    : this.street
                    ? [this.street]
                    : [];

                if (this.district && !streetLines.includes(this.district)) {
                    streetLines.push(this.district);
                }

                const regionPayload =
                    this.regionData && Object.keys(this.regionData).length > 0
                        ? { ...this.regionData }
                        : this.region
                        ? { region: this.region }
                        : null;

                const address = {
                    street: streetLines,
                    city: this.city || '',
                    postcode: this.postcode || '',
                    country_id: this.country || 'SA'
                };

                if (regionPayload) {
                    address.region = regionPayload;
                    if (regionPayload.region_id) {
                        address.region_id = regionPayload.region_id;
                    }
                    if (regionPayload.region_code) {
                        address.region_code = regionPayload.region_code;
                    }
                } else if (this.region) {
                    address.region = this.region;
                }

                if (this.district) {
                    address.district = this.district;
                }

                const firstnameInput = document.querySelector('input[name="firstname"]');
                const lastnameInput = document.querySelector('input[name="lastname"]');
                const telephoneInput = document.querySelector('input[name="telephone"]');

                if (firstnameInput?.value) {
                    address.firstname = firstnameInput.value;
                }
                if (lastnameInput?.value) {
                    address.lastname = lastnameInput.value;
                }
                if (telephoneInput?.value) {
                    address.telephone = telephoneInput.value;
                }

                if (
                    address.street.length ||
                    address.city ||
                    address.region ||
                    address.postcode
                ) {
                    address.latitude = this.latitude;
                    address.longitude = this.longitude;
                    payload.address = address;
                }

                return payload;
            },

            findNearestBranch(lat, lng, sourcesData) {
                if (!Array.isArray(sourcesData) || sourcesData.length === 0) {
                    return null;
                }

                let nearestBranch = null;
                let shortestDistance = Infinity;

                sourcesData.forEach((source) => {
                    if (!source.latitude || !source.longitude || !source.delivery_range_km) {
                        return;
                    }

                    const distance = this.calculateDistance(
                        lat,
                        lng,
                        parseFloat(source.latitude),
                        parseFloat(source.longitude)
                    );

                    const deliveryRange = parseFloat(source.delivery_range_km);

                    if (distance <= deliveryRange && distance < shortestDistance) {
                        shortestDistance = distance;
                        nearestBranch = source;
                    }
                });

                return nearestBranch;
            },

            calculateDistance(lat1, lon1, lat2, lon2) {
                const toRad = (value) => (value * Math.PI) / 180;
                const R = 6371; // Earth's radius in km
                const dLat = toRad(lat2 - lat1);
                const dLon = toRad(lon2 - lon1);
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(toRad(lat1)) *
                        Math.cos(toRad(lat2)) *
                        Math.sin(dLon / 2) *
                        Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            },

            useCurrentLocation() {
                if (!navigator.geolocation) {
                    alert('<?= __('Geolocation is not supported by your browser') ?>');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        this.updateLocation(lat, lng);

                        // Update map
                        const newPosition = {
                            lat,
                            lng
                        };
                        this.map.setCenter(newPosition);
                        this.marker.setPosition(newPosition);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('<?= __('Unable to get your location. Please search for your address.') ?>');
                    }
                );
            },

            onAddressInput(event) {
                // This is handled by Google Places Autocomplete
            }
        };
    }
</script>