<?php

declare(strict_types=1);

use Magento\Catalog\Model\Product;
use Magento\ConfigurableProduct\Model\Product\Type\Configurable as ConfigurableType;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Swatches\Model\Swatch;

/** @var Template $block */
/** @var Escaper $escaper */

$swatchConfig = json_decode($block->getJsonSwatchConfig() ?? '[]', true);
$baseConfig = json_decode($block->getJsonConfig() ?? '[]', true);
$attributes = $swatchConfig['attributes'] ?? [];

if (!$attributes) {
    return;
}

/** @var Product|null $product */
$product = $block->getProduct();
$productIdToSku = [];
if ($product) {
    $typeInstance = $product->getTypeInstance();
    if ($typeInstance instanceof ConfigurableType) {
        $children = $typeInstance->getUsedProducts($product);
    } else {
        $children = $product->getTypeInstance()->getUsedProducts($product);
    }
    foreach ($children as $child) {
        $productIdToSku[(int) $child->getId()] = (string) $child->getSku();
    }
}

$deliverabilityConfig = $baseConfig['attributes']['is_deliverable']['options'] ?? [];
$deliverabilityByProductId = [];
foreach ($deliverabilityConfig as $deliverabilityOption) {
    if (!isset($deliverabilityOption['id'])) {
        continue;
    }
    $label = strtolower((string) ($deliverabilityOption['label'] ?? ''));
    $deliverabilityByProductId[(int) $deliverabilityOption['id']] = $label === 'yes';
}

$textSwatchType = (int) Swatch::SWATCH_TYPE_TEXT;
$visualImageSwatchType = defined(Swatch::class . '::SWATCH_TYPE_VISUAL_IMAGE')
    ? (int) Swatch::SWATCH_TYPE_VISUAL_IMAGE
    : 2;
?>
<?php foreach ($attributes as $attribute): ?>
    <?php
    $attributeCode = (string)($attribute['code'] ?? $attribute['attribute_code'] ?? '');
    if ($attributeCode === 'is_deliverable') {
        continue;
    }
    $attributeId = (int)($attribute['id'] ?? $attribute['attribute_id'] ?? 0);
    $attributeLabel = (string)($attribute['label'] ?? '');
    $attributeOptions = $attribute['options'] ?? [];
    if (!$attributeOptions) {
        continue;
    }

    $optionSkuMap = [];
    foreach ($attributeOptions as $option) {
        $optionId = (string)($option['id'] ?? $option['value'] ?? '');
        if ($optionId === '') {
            continue;
        }
        $optionProductIds = $option['products'] ?? [];
        $skus = [];
        foreach ($optionProductIds as $productId) {
            $productId = (int) $productId;
            if (!isset($productIdToSku[$productId])) {
                continue;
            }
            $sku = $productIdToSku[$productId];
            $skus[] = $sku;
        }
        $optionSkuMap[$optionId] = array_values(array_unique($skus));
    }

    $optionSkuJson = htmlspecialchars(json_encode($optionSkuMap, JSON_THROW_ON_ERROR), ENT_QUOTES, 'UTF-8');
    $allSkus = [];
    foreach ($optionSkuMap as $skusForOption) {
        foreach ($skusForOption as $sku) {
            $allSkus[$sku] = true;
        }
    }
    $allSkusJson = htmlspecialchars(json_encode(array_keys($allSkus), JSON_THROW_ON_ERROR), ENT_QUOTES, 'UTF-8');
    ?>
    <div
        class="swatch-attribute mb-4"
        data-role="swatch-attribute"
        data-attribute-code="<?= $escaper->escapeHtmlAttr($attributeCode) ?>"
        data-attribute-id="<?= $escaper->escapeHtmlAttr((string) $attributeId) ?>"
        data-attribute-label="<?= $escaper->escapeHtmlAttr($attributeLabel) ?>"
        x-data="{
            optionSkus: <?= $optionSkuJson ?>,
            allSkus: <?= $allSkusJson ?>,
            init() {
                this.registerWithDeliverability();
            },
            registerWithDeliverability(attempt = 0) {
                if (!Array.isArray(this.allSkus) || this.allSkus.length === 0) {
                    return;
                }
                if (window.DeliverabilityService && typeof window.DeliverabilityService.registerSkus === 'function') {
                    window.DeliverabilityService.registerSkus(this.allSkus);
                    return;
                }
                if (attempt < 20) {
                    setTimeout(() => this.registerWithDeliverability(attempt + 1), 100);
                }
            },
            deliverabilityStore() {
                return Alpine.store('deliverability');
            },
            hasLocation() {
                const store = this.deliverabilityStore();
                return !!(store && store.selected_source_code);
            },
            isDeliverable(optionId) {
                const store = this.deliverabilityStore();
                if (!store || typeof store.isDeliverable !== 'function') {
                    return true;
                }
                const skus = this.optionSkus[optionId] || [];
                if (!Array.isArray(skus) || skus.length === 0) {
                    return true;
                }
                if (!this.hasLocation()) {
                    return true;
                }
                return skus.some((sku) => store.isDeliverable(sku));
            },
            shouldDisable(optionId) {
                return this.hasLocation() && !this.isDeliverable(optionId);
            },
            shouldHide(optionId) {
                const store = this.deliverabilityStore();
                return this.shouldDisable(optionId) && !!(store && store.hideUndeliverable);
            }
        }"
    >
        <div class="flex items-center gap-3 mb-2">
            <span class="font-semibold text-sm uppercase">
                <?= $escaper->escapeHtml($attributeLabel) ?>
            </span>
            <span class="text-sm" data-role="selected-option"></span>
        </div>
        <div
            class="swatch-attribute-options flex flex-wrap gap-2"
            id="attribute<?= $escaper->escapeHtmlAttr((string) $attributeId) ?>"
            role="listbox"
        >
            <?php foreach ($attributeOptions as $option): ?>
                <?php
                $optionId = (string)($option['id'] ?? $option['value'] ?? '');
                if ($optionId === '') {
                    continue;
                }
                $optionLabel = (string)($option['label'] ?? $option['option_label'] ?? '');
                $optionThumb = (string)($option['thumb'] ?? '');
                $optionTooltip = (string)($option['tooltip'] ?? $optionLabel);
                $optionType = (int)($option['type'] ?? $textSwatchType);
                $optionValue = (string)($option['value'] ?? '');

                $optionClass = 'swatch-option';
                $styleAttribute = '';
                if ($optionType === $textSwatchType) {
                    $optionClass .= ' text';
                } else {
                    $isImageSwatch = $optionType === $visualImageSwatchType
                        || (!$optionValue && !empty($optionThumb));
                    if (!$isImageSwatch && $optionValue) {
                        $normalizedValue = strtolower($optionValue);
                        $isImageSwatch = strpos($normalizedValue, 'http') === 0
                            || strpos($normalizedValue, 'data:') === 0
                            || (substr($normalizedValue, -4) === '.png'
                                || substr($normalizedValue, -4) === '.jpg'
                                || substr($normalizedValue, -4) === '.gif'
                                || substr($normalizedValue, -5) === '.jpeg'
                                || substr($normalizedValue, -5) === '.webp');
                    }

                    if ($isImageSwatch) {
                        $optionClass .= ' image';
                        if ($optionValue) {
                            $optionUrl = $escaper->escapeUrl($optionValue);
                            $styleAttribute = "background: url('{$optionUrl}') no-repeat center / cover;";
                        }
                    } else {
                        $optionClass .= ' color';
                        if ($optionValue) {
                            $styleAttribute = 'background: ' . $escaper->escapeHtmlAttr($optionValue) . ';';
                        }
                    }
                }

                $optionProductIds = $option['products'] ?? [];
                $isDeliverable = false;
                foreach ($optionProductIds as $productId) {
                    $productId = (int) $productId;
                    if (!isset($deliverabilityByProductId[$productId])) {
                        $isDeliverable = true;
                        break;
                    }
                    if ($deliverabilityByProductId[$productId]) {
                        $isDeliverable = true;
                        break;
                    }
                }

                $optionSkus = $optionSkuMap[$optionId] ?? [];
                $optionSkusJson = htmlspecialchars(json_encode($optionSkus, JSON_THROW_ON_ERROR), ENT_QUOTES, 'UTF-8');
                ?>
                <div
                    class="<?= $escaper->escapeHtmlAttr($optionClass) ?> border border-container rounded"
                    role="option"
                    tabindex="0"
                    aria-checked="false"
                    aria-label="<?= $escaper->escapeHtmlAttr($optionLabel) ?>"
                    data-option-type="<?= $escaper->escapeHtmlAttr((string) $optionType) ?>"
                    data-option-id="<?= $escaper->escapeHtmlAttr($optionId) ?>"
                    data-option-label="<?= $escaper->escapeHtmlAttr($optionLabel) ?>"
                    data-option-tooltip-thumb="<?= $escaper->escapeHtmlAttr($optionThumb) ?>"
                    data-option-tooltip-value="<?= $escaper->escapeHtmlAttr($optionTooltip) ?>"
                    data-option-tooltip-html="<?= $escaper->escapeHtmlAttr($optionTooltip) ?>"
                    data-option-final-price="0"
                    data-attribute-id="<?= $escaper->escapeHtmlAttr((string) $attributeId) ?>"
                    data-attribute-code="<?= $escaper->escapeHtmlAttr($attributeCode) ?>"
                    data-swatch-option-skus='<?= $optionSkusJson ?>'
                    data-deliverable="<?= $isDeliverable ? '1' : '0' ?>"
                    x-show="!shouldHide('<?= $escaper->escapeHtmlAttr($optionId) ?>')"
                    :aria-disabled="shouldDisable('<?= $escaper->escapeHtmlAttr($optionId) ?>') ? 'true' : 'false'"
                    :class="{
                        'pointer-events-none opacity-50 cursor-not-allowed line-through': shouldDisable('<?= $escaper->escapeHtmlAttr($optionId) ?>'),
                        'hidden': shouldHide('<?= $escaper->escapeHtmlAttr($optionId) ?>')
                    }"
                    x-effect="$el.dataset.deliverable = isDeliverable('<?= $escaper->escapeHtmlAttr($optionId) ?>') ? '1' : '0'"
                    <?php if ($styleAttribute): ?>style="<?= $styleAttribute ?>"<?php endif; ?>
                >
                    <?php if ($optionType === $textSwatchType): ?>
                        <span class="px-3 py-1 text-sm" title="<?= $escaper->escapeHtmlAttr($optionLabel) ?>">
                            <?= $escaper->escapeHtml($optionLabel) ?>
                        </span>
                    <?php else: ?>
                        <span class="sr-only"><?= $escaper->escapeHtml($optionLabel) ?></span>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
        </div>
    </div>
<?php endforeach; ?>
