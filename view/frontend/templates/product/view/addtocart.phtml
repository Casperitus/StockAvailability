<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\CurrentProduct;
use Magento\Catalog\Model\Product;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var HeroiconsOutline $heroicons */
$heroicons = $viewModels->require(HeroiconsOutline::class);
/** @var CurrentProduct $currentProduct */
$currentProduct = $viewModels->require(CurrentProduct::class);

/** @var Product $product */
$product = $block->hasData('product')
    ? $block->getData('product')
    : $currentProduct->get();

if (!$product || !$product->getId()) {
    return;
}

$isCartConfigure = (bool) $block->getData('is_cart_configure');
$deliverableValue = $product->getData('is_deliverable');
$deliverableFlag = $product->getData('is_deliverable_flag');
$deliverableLabelData = $product->getData('is_deliverable_label');

if ($deliverableFlag === null && is_string($deliverableLabelData)) {
    $deliverableFlag = strcasecmp($deliverableLabelData, 'Deliverable') === 0;
}

if ($deliverableFlag === null && $deliverableValue !== null) {
    if (is_bool($deliverableValue)) {
        $deliverableFlag = $deliverableValue;
    } elseif (is_string($deliverableValue)) {
        $deliverableFlag = strcasecmp($deliverableValue, 'Deliverable') === 0;
    } else {
        $deliverableFlag = ((int) $deliverableValue) === 1;
    }
}

$isDeliverable = $deliverableFlag === null ? null : (bool) $deliverableFlag;

$defaultLabel = $isCartConfigure ? __('Update item') : __('Add to Cart');
$buttonLabel = $isDeliverable === false ? __('Request Item') : $defaultLabel;
$buttonDisabled = $isDeliverable === false;
?>

<div class="flex flex-col gap-2 md:flex-row md:items-center">
    <button
        type="submit"
        form="product_addtocart_form"
        class="btn btn-primary flex items-center gap-2 justify-center w-full md:w-auto"
        id="product-addtocart-button"
        data-addto="cart"
        title="<?= $escaper->escapeHtmlAttr($buttonLabel) ?>"
        <?= $buttonDisabled ? 'disabled' : '' ?>>
        <span class="icon-wrapper">
            <?= $heroicons->shoppingCartHtml('border-current'); ?>
        </span>
        <span><?= $escaper->escapeHtml($buttonLabel) ?></span>
    </button>

    <?php if ($isDeliverable === false): ?>
        <span class="text-sm text-red-700">
            <?= $escaper->escapeHtml(__('This item is requestable for your selected location.')) ?>
        </span>
    <?php endif; ?>
</div>

<div class="additional-actions mt-2">
    <?= $block->getChildHtml('', true) ?>
</div>
