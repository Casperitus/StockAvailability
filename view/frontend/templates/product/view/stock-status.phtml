<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\CurrentProduct;
use Magento\Catalog\Model\Product;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var CurrentProduct $currentProduct */
$currentProduct = $viewModels->require(CurrentProduct::class);

/** @var Product $product */
$product = $block->hasData('product')
    ? $block->getData('product')
    : $currentProduct->get();

if (!$product || !$product->getId()) {
    return;
}

$inStock = $product->getIsSalable();
$deliverableValue = $product->getData('is_deliverable');
$deliverableFlag = $product->getData('is_deliverable_flag');

if ($deliverableFlag !== null) {
    $isDeliverable = (bool) $deliverableFlag;
} elseif ($deliverableValue === null) {
    $isDeliverable = null;
} elseif (is_bool($deliverableValue)) {
    $isDeliverable = $deliverableValue;
} elseif (is_string($deliverableValue)) {
    $isDeliverable = strcasecmp($deliverableValue, 'Deliverable') === 0;
} else {
    $isDeliverable = ((int) $deliverableValue) === 1;
}

$deliverabilityLabel = $isDeliverable === null
    ? __('Please select location')
    : ($isDeliverable ? __('Deliverable') : __('Requestable'));

$deliverabilityClasses = match ($isDeliverable) {
    true => ['container' => 'bg-green-100 text-green-800', 'dot' => 'bg-green-500'],
    false => ['container' => 'bg-red-100 text-red-800', 'dot' => 'bg-red-500'],
    default => ['container' => 'bg-gray-100 text-gray-700', 'dot' => 'bg-gray-500'],
};
?>

<?php if ($block->getParentBlock()->displayProductStockStatus()): ?>
    <div class="flex flex-col gap-2">
        <div class="flex items-center gap-2 p-2 rounded-lg <?= $inStock ? 'bg-green-100' : 'bg-red-100' ?>">
            <span class="w-3 h-3 rounded-full shrink-0 <?= $inStock ? 'bg-green-500' : 'bg-red-500' ?>"></span>
            <span class="text-gray-800 text-sm">
                <?= $escaper->escapeHtml($inStock ? __('In stock') : __('Out of stock')) ?>
            </span>
        </div>

        <div class="flex items-center gap-2 p-2 rounded-lg <?= $deliverabilityClasses['container'] ?>">
            <span class="w-3 h-3 rounded-full shrink-0 <?= $deliverabilityClasses['dot'] ?>"></span>
            <span class="text-sm">
                <?= $escaper->escapeHtml($deliverabilityLabel) ?>
            </span>
        </div>
    </div>
<?php endif; ?>
