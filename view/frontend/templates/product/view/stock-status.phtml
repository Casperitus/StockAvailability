<?php

/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\CurrentProduct;
use Magento\Catalog\Model\Product;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var CurrentProduct $currentProduct */
$currentProduct = $viewModels->require(CurrentProduct::class);

/** @var Product $product */
$product = $block->hasData('product')
    ? $block->getData('product')
    : $currentProduct->get();

if (!$product || !$product->getId()) {
    return;
}

// Original Hyvä logic for stock:
$inStock = $product->getIsSalable();
?>

<?php if ($block->getParentBlock()->displayProductStockStatus()): ?>
    <!-- We wrap everything in x-data to register SKU and show second line for deliverability -->
    <div
        x-data="{
            sku: '<?= $escaper->escapeJs($product->getSku()) ?>',

            get selectedSourceCode() {
                return Alpine.store('deliverability').selected_source_code || '';
            },

            // If there's a source code, read the deliverability map
            get isDeliverable() {
                return Alpine.store('deliverability').map[this.sku] === 'Yes';
            },

            get deliverabilityLabel() {
                if (!this.selectedSourceCode) {
                    return '<?= $escaper->escapeHtml(__('Please select location')) ?>';
                }
                return this.isDeliverable
                    ? '<?= $escaper->escapeHtml(__('Deliverable')) ?>'
                    : '<?= $escaper->escapeHtml(__('Undeliverable')) ?>';
            },

            init() {
                // Register SKU with DeliverabilityService
                DeliverabilityService.registerSku(this.sku);
            },

            // Optional: method to open location modal
            openLocationModal() {
                if (window.toggleDeliveryLocationModal) {
                    window.toggleDeliveryLocationModal();
                } else {
                    console.warn('toggleDeliveryLocationModal not found');
                }
            }
        }">
        <div class="flex items-center gap-4">
            <!-- Stock Availability -->
            <div
                class="flex items-center gap-2 p-2 rounded-lg <?= $inStock ? 'bg-green-100' : 'bg-red-100' ?>"
                title="<?= $escaper->escapeHtmlAttr(__('Availability')) ?>">
                <span
                    class="w-3 h-3 rounded-full shrink-0 <?= $inStock ? 'bg-green-500' : 'bg-red-500' ?>">
                </span>
                <span class="text-gray-800 text-sm">
                    <?= $escaper->escapeHtml($inStock ? __('In stock') : __('Out of stock')) ?>
                </span>
            </div>

            <!-- Delivery Availability -->
            <div
                class="flex items-center gap-2 p-2 rounded-lg"
                :class="(selectedSourceCode && isDeliverable) ? 'bg-green-100' : (selectedSourceCode ? 'bg-red-100' : 'bg-gray-200')"
                title="<?= $escaper->escapeHtmlAttr(__('Delivery Availability')) ?>">
                <!-- Dot changes color if source code is set -->
                <span
                    class="w-3 h-3 rounded-full shrink-0"
                    :class="(selectedSourceCode && isDeliverable)
                             ? 'bg-green-500'
                             : (selectedSourceCode ? 'bg-red-500' : 'bg-gray-500')">
                </span>

                <!-- The text will show "Please select location" (clickable), or "Deliverable"/"Undeliverable" -->
                <span class="text-gray-800 text-sm">
                    <a href="javascript:void(0)" @click="openLocationModal()"
                        x-text="deliverabilityLabel"
                        class="cursor-pointer"></a>
                </span>
            </div>
        </div>
    </div>
<?php endif; ?>