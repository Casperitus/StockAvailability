<?php

/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes ...
 */

declare(strict_types=1);

use Magento\Catalog\Block\Product\View\BaseImage;
use Magento\Catalog\Pricing\Price\TierPrice;
use Magento\GroupedProduct\Block\Product\View\Type\Grouped;
use Magento\Framework\Escaper;

/**
 * @var BaseImage|Grouped $block
 * @var Escaper $escaper
 */

$block->setPreconfiguredValue();
$product            = $block->getProduct();
$associatedProducts = $block->getAssociatedProducts();
$hasAssociatedProducts = count($associatedProducts) > 0;
?>
<script>
    // Collect grouped child SKUs once per page
    window.groupedChildSkus = window.groupedChildSkus || [];
</script>

<script>
    function initGroupedOptions() {
        return {
            isValid: true,
            validateForm() {
                const validateInputs = Array.from(
                    document.querySelectorAll('input[name^=super_group]')
                );

                // At least one of the inputs has to have a qty > 0
                this.isValid = validateInputs.filter(
                    input => parseFloat(input.value || 0) > 0
                ).length;

                // Set or unset validity for all fields at once
                validateInputs.map(input =>
                    input.setCustomValidity(
                        this.isValid ?
                        "" :
                        "<?= $escaper->escapeJs(__('Please specify the quantity of product(s).')) ?>"
                    )
                );

                if (!this.isValid) {
                    // Trigger immediate display of the form errors
                    const form = document.querySelector("#product_addtocart_form");
                    if (form) {
                        form.reportValidity();
                    }
                    return false;
                }
                return true;
            },
            init() {
                const form = document.querySelector("#product_addtocart_form");
                if (!form) return;

                form.addEventListener("submit", (e) => {
                    if (!this.validateForm()) {
                        e.preventDefault();
                    }
                });
            }
        }
    }
</script>

<div class="product-grouped-options" x-data="initGroupedOptions()">
    <?php if ($hasAssociatedProducts): ?>
        <h2 class="text-xl font-medium mb-2">
            <?= $escaper->escapeHtml(__('Grouped product items')) ?>
        </h2>
        <div class="hidden sm:flex py-2 items-center justify-between gap-2">
            <div class="text-fg-secondary font-semibold">
                <?= $escaper->escapeHtml(__('Product Name')) ?>
            </div>
            <div class="text-fg-secondary font-semibold w-20">
                <?= $escaper->escapeHtml(__('Qty')) ?>
            </div>
        </div>

        <?php foreach ($associatedProducts as $item): ?>
            <?php
            $itemSku        = $escaper->escapeJs($item->getSku() ?: '');
            $itemIsSaleable = $item->isSaleable() ? 'true' : 'false';
            ?>
            <script>
                // Push each child SKU into the global array
                window.groupedChildSkus.push('<?= $itemSku ?>');
            </script>

            <div
                class="sm:flex border-t border-gray-300 py-2 items-center justify-between gap-4"
                <?php foreach ($block->getData('product_data_attributes') ?? [] as $attribute => $include): ?>
                <?php if ($include): ?>
                <?= $escaper->escapeHtml(sprintf('data-%s', $attribute)); ?>="<?= $escaper->escapeHtmlAttr($item->getData($attribute)); ?>"
                <?php endif; ?>
                <?php endforeach; ?>
                x-data="{
                    sku: '<?= $itemSku ?>',
                    get isSaleable() { return <?= $itemIsSaleable ?> },
                    get isDeliverable() {
                        const store = Alpine.store('deliverability');
                        if (!store || !store.map) return true; // fallback: treat as deliverable
                        return store.map[this.sku] === 'Yes';
                    }
                }">
                <label
                    for="super_group[<?= $escaper->escapeHtmlAttr($item->getId()) ?>]"
                    class="text-fg">
                    <span class="product-item-name">
                        <?= $escaper->escapeHtml($item->getName()) ?>
                    </span>
                    <?php if ($block->getCanShowProductPrice($product)): ?>
                        <?php if ($block->getCanShowProductPrice($item)): ?>
                            <?= /* @noEscape */ $block->getProductPrice($item) ?>
                        <?php endif; ?>
                    <?php endif; ?>
                </label>

                <div class="text-left sm:text-right w-full sm:w-20">
                    <?php if ($product->isSaleable()): ?>
                        <!-- Qty input shown only when item is saleable AND deliverable -->
                        <template x-if="isSaleable && isDeliverable">
                            <div class="control qty">
                                <input
                                    type="number"
                                    min="0"
                                    name="super_group[<?= $escaper->escapeHtmlAttr($item->getId()) ?>]"
                                    id="super_group[<?= $escaper->escapeHtmlAttr($item->getId()) ?>]"
                                    value="<?= $escaper->escapeHtmlAttr($item->getQty() * 1) ?>"
                                    title="<?= $escaper->escapeHtmlAttr(__('Qty')) ?>"
                                    class="form-input qty w-full"
                                    :class="{ 'border-red-500 focus:border-red-500 focus:ring-red-500': !isValid }"
                                    @input.debounce="validateForm()">
                            </div>
                        </template>

                        <!-- Out of stock when the item itself is not saleable -->
                        <template x-if="!isSaleable">
                            <div
                                class="stock unavailable"
                                title="<?= $escaper->escapeHtmlAttr(__('Availability')) ?>">
                                <?= $escaper->escapeHtml(__('Out of stock')) ?>
                            </div>
                        </template>

                        <!-- Undeliverable when saleable BUT delivery map says "No" -->
                        <template x-if="isSaleable && !isDeliverable">
                            <div
                                class="stock unavailable text-sm text-red-600"
                                title="<?= $escaper->escapeHtmlAttr(__('Availability')) ?>">
                                <?= $escaper->escapeHtml(__('Undeliverable')) ?>
                            </div>
                        </template>
                    <?php endif; ?>
                </div>

                <?php if (
                    $block->getCanShowProductPrice($product)
                    && $block->getCanShowProductPrice($item)
                    && trim($block->getProductPriceHtml($item, TierPrice::PRICE_CODE))
                ): ?>
                    <div class="flex pt-2 w-full items-center">
                        <?= $block->getProductPriceHtml($item, TierPrice::PRICE_CODE) ?>
                    </div>
                <?php endif; ?>
            </div>
        <?php endforeach; ?>

        <!-- One-time registration after loop -->
        <script>
            document.addEventListener('alpine:init', () => {
                if (window.groupedChildSkus && window.groupedChildSkus.length && window.DeliverabilityService) {
                    DeliverabilityService.registerSkus(window.groupedChildSkus);
                }
            });
        </script>

    <?php else: ?>
        <?= $escaper->escapeHtml(__('No options of this product are available.')) ?>
    <?php endif; ?>
</div>