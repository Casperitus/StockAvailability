<?php

/** @var \Madar\StockAvailability\Block\GoogleMaps $block */
$product = $block->getProduct();
if (!$product) {
    return;
}

// Common Saudi cities for quick selection
$commonCities = [
    'Riyadh' => 'Riyadh',
    'Jeddah' => 'Jeddah',
    'Makkah' => 'Makkah',
    'Medina' => 'Medina',
    'Dammam' => 'Dammam',
    'Khobar' => 'Khobar',
    'Tabuk' => 'Tabuk',
    'Buraidah' => 'Buraidah',
    'Khamis Mushait' => 'Khamis Mushait',
    'Hail' => 'Hail'
];
?>

<div x-data="storeAvailabilityComponent()" x-init="init()" class="store-availability-section border-t pt-6 mt-6">
    <h3 class="text-lg font-semibold mb-4"><?= $escaper->escapeHtml(__('Check availability at stores near you')) ?></h3>

    <!-- City Search Input -->
    <div class="mb-4">
        <label for="city-search" class="block text-sm font-medium text-gray-700 mb-2">
            <?= $escaper->escapeHtml(__('Select or enter your city')) ?>
        </label>

        <!-- Quick City Buttons -->
        <div class="mb-3 flex flex-wrap gap-2">
            <?php foreach ($commonCities as $arabicName => $englishName): ?>
                <button
                    @click="searchByCity('<?= $escaper->escapeJs($englishName) ?>')"
                    class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-full border"
                    type="button">
                    <?= $escaper->escapeHtml(__($arabicName)) ?>
                </button>
            <?php endforeach; ?>
        </div>

        <!-- Manual City Input -->
        <div class="flex gap-2">
            <input
                type="text"
                id="city-search"
                x-ref="cityInput"
                x-model="cityName"
                @keyup.enter="searchByCity(cityName)"
                placeholder="<?= $escaper->escapeHtmlAttr(__('Or type city name (Arabic or English)')) ?>"
                class="flex-1 form-input border border-gray-300 rounded-md px-3 py-2" />
            <button
                @click="searchByCity(cityName)"
                :disabled="!cityName.trim() || isLoading"
                class="btn btn-primary px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <?= $escaper->escapeHtml(__('Search')) ?>
            </button>
            <button
                @click="useCurrentLocation()"
                :disabled="isLoading"
                class="btn btn-secondary px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50">
                üìç
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">
            <?= $escaper->escapeHtml(__('Click a city above or type your city name')) ?>
        </p>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="text-center py-6">
        <div class="animate-spin w-6 h-6 border-2 border-gray-300 border-t-blue-600 rounded-full mx-auto mb-2"></div>
        <p class="text-gray-600" x-text="loadingMessage"><?= $escaper->escapeHtml(__('Searching...')) ?></p>
    </div>

    <!-- Search Results Info -->
    <div x-show="searchPerformed && !isLoading && searchedCity" class="mb-4 p-3 bg-blue-50 rounded-lg">
        <p class="text-sm text-blue-800">
            <strong><?= $escaper->escapeHtml(__('Showing stores near:')) ?></strong>
            <span x-text="searchedCity"></span>
        </p>
    </div>

    <div x-show="searchPerformed && !isLoading && availableStores.length > 0" class="mb-4 grid grid-cols-2 gap-4">
        <div class="bg-green-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-green-700" x-text="getStoreCountByStatus('in_stock')"></div>
            <div class="text-sm text-green-600"><?= $escaper->escapeHtml(__('Stores with immediate stock')) ?></div>
        </div>
        <div class="bg-yellow-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-yellow-700" x-text="getStoreCountByStatus('backorder')"></div>
            <div class="text-sm text-yellow-600"><?= $escaper->escapeHtml(__('Stores can order from warehouse')) ?></div>
        </div>
    </div>

    <!-- Available Stores List -->
    <div x-show="!isLoading && availableStores.length > 0" class="space-y-3">
        <h4 class="font-medium text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <?= $escaper->escapeHtml(__('Available at these stores')) ?>
            <span class="text-sm font-normal text-gray-600" x-text="'(' + availableStores.length + ' found)'"></span>
        </h4>

        <!-- Group stores by stock status -->
        <div x-show="getStoresByStatus('in_stock').length > 0" class="mb-4">
            <h5 class="text-sm font-medium text-gray-700 mb-2"><?= $escaper->escapeHtml(__('In Stock at Store')) ?></h5>
            <template x-for="store in getStoresByStatus('in_stock')" :key="store.source_code">
                <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow mb-2">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-medium text-gray-900 mb-1" x-text="store.source_name"></h5>
                            <p class="text-sm text-gray-600 mb-2" x-show="store.phone">
                                üìû <span x-text="store.phone"></span>
                            </p>
                            <p class="text-sm text-gray-500">
                                üìç <span x-text="store.distance"></span> km away
                            </p>
                        </div>
                        <div class="text-right ml-4">
                            <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mb-2">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <?= $escaper->escapeHtml(__('In Stock')) ?>
                            </div>
                            <div>
                                <button
                                    @click="getDirections(store)"
                                    class="text-xs text-blue-600 hover:underline">
                                    <?= $escaper->escapeHtml(__('Get Directions')) ?>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="getStoresByStatus('backorder').length > 0">
            <h5 class="text-sm font-medium text-gray-700 mb-2"><?= $escaper->escapeHtml(__('Available for Order (Ships from Warehouse)')) ?></h5>
            <template x-for="store in getStoresByStatus('backorder')" :key="store.source_code">
                <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow mb-2">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-medium text-gray-900 mb-1" x-text="store.source_name"></h5>
                            <p class="text-sm text-gray-600 mb-2" x-show="store.phone">
                                üìû <span x-text="store.phone"></span>
                            </p>
                            <p class="text-sm text-gray-500">
                                üìç <span x-text="store.distance"></span> km away
                            </p>
                            <p class="text-xs text-gray-500 italic mt-1">
                                <?= $escaper->escapeHtml(__('This location can order this item from our warehouse')) ?>
                            </p>
                        </div>
                        <div class="text-right ml-4">
                            <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 mb-2">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                                <?= $escaper->escapeHtml(__('Backorder')) ?>
                            </div>
                            <div>
                                <button
                                    @click="getDirections(store)"
                                    class="text-xs text-blue-600 hover:underline">
                                    <?= $escaper->escapeHtml(__('Get Directions')) ?>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- No Available Stores Message -->
    <div x-show="!isLoading && searchPerformed && availableStores.length === 0" class="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
        <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
        </svg>
        <p class="text-lg font-medium mb-2"><?= $escaper->escapeHtml(__('No stores found with this product in stock')) ?></p>
        <p class="text-sm">
            <?= $escaper->escapeHtml(__('This product is not available at stores near')) ?>
            <span x-text="searchedCity" class="font-medium"></span>
        </p>
        <p class="text-xs mt-2"><?= $escaper->escapeHtml(__('Try searching for a different city or check online availability.')) ?></p>
    </div>
</div>

<script>
    function storeAvailabilityComponent() {
        return {
            availableStores: [],
            searchPerformed: false,
            isLoading: false,
            cityName: '',
            searchedCity: '',
            loadingMessage: '<?= $escaper->escapeJs(__('Searching...')) ?>',

            init() {
                console.log('Store availability component initialized');
            },

            // Add new method to filter stores by status
            getStoresByStatus(status) {
                return this.availableStores.filter(store => store.stock_status === status);
            },

            // Add method to count stores by type
            getStoreCountByStatus(status) {
                return this.getStoresByStatus(status).length;
            },

            async searchByCity(cityName) {
                if (!cityName || !cityName.trim()) {
                    alert('<?= $escaper->escapeJs(__('Please enter a city name')) ?>');
                    return;
                }

                this.isLoading = true;
                this.searchPerformed = true;
                this.availableStores = [];
                this.searchedCity = cityName.trim();
                this.loadingMessage = '<?= $escaper->escapeJs(__('Finding location...')) ?>';

                try {
                    // First, geocode the city to get coordinates
                    const coordinates = await this.geocodeCity(cityName);

                    if (coordinates) {
                        this.loadingMessage = '<?= $escaper->escapeJs(__('Searching for available stores...')) ?>';
                        await this.searchAvailableStores(coordinates.lat, coordinates.lng);
                    } else {
                        this.availableStores = [];
                        alert('<?= $escaper->escapeJs(__('City not found. Please check the spelling and try again.')) ?>');
                    }

                } catch (error) {
                    console.error('Error searching by city:', error);
                    this.availableStores = [];
                    alert('<?= $escaper->escapeJs(__('Error searching for stores. Please try again.')) ?>');
                } finally {
                    this.isLoading = false;
                }
            },

            async geocodeCity(cityName) {
                try {
                    // Try searching for "city" specifically first
                    let query = encodeURIComponent(`${cityName} city, Saudi Arabia`);
                    let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=10&addressdetails=1&countrycodes=sa`);
                    let results = await response.json();

                    console.log(`First search for "${cityName} city":`, results.length, 'results');

                    // If no results or only administrative results, try without "city"
                    if (!results || results.length === 0 ||
                        (results.length > 0 && results.every(r => r.type === 'administrative' || r.addresstype === 'state'))) {

                        query = encodeURIComponent(`${cityName}, Saudi Arabia`);
                        response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=10&addressdetails=1&countrycodes=sa`);
                        results = await response.json();
                        console.log(`Second search for "${cityName}":`, results.length, 'results');
                    }

                    // If still no good results, try with specific place types
                    if (!results || results.length === 0 ||
                        (results.length > 0 && results.every(r => r.type === 'administrative' || r.addresstype === 'state'))) {

                        // Try searching with place:city specifically
                        const placeQuery = encodeURIComponent(`place:city ${cityName}, Saudi Arabia`);
                        response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${placeQuery}&limit=10&addressdetails=1`);
                        results = await response.json();
                        console.log(`Third search with place:city:`, results.length, 'results');
                    }

                    if (results && results.length > 0) {
                        console.log('All results:', results);

                        // Find the best match - prefer actual cities/towns over administrative regions
                        let bestResult = null;

                        // First pass: look for actual cities/towns
                        for (const result of results) {
                            // Check place_rank - cities typically have rank 13-16
                            if (result.place_rank >= 13 && result.place_rank <= 16 &&
                                result.type !== 'administrative' &&
                                result.addresstype !== 'state') {
                                bestResult = result;
                                console.log(`Selected by place_rank: ${result.display_name} (rank: ${result.place_rank})`);
                                break;
                            }

                            // Check for city/town/village types
                            if ((result.type === 'city' ||
                                    result.type === 'town' ||
                                    result.type === 'village' ||
                                    result.type === 'municipality') &&
                                result.class === 'place') {
                                bestResult = result;
                                console.log(`Selected by type: ${result.display_name} (type: ${result.type})`);
                                break;
                            }
                        }

                        // Second pass: look for results that mention city in address
                        if (!bestResult) {
                            for (const result of results) {
                                if (result.address &&
                                    (result.address.city === cityName ||
                                        result.address.town === cityName ||
                                        result.address.city_district)) {
                                    bestResult = result;
                                    console.log(`Selected by address field: ${result.display_name}`);
                                    break;
                                }
                            }
                        }

                        // For Riyadh specifically, we know it should be around 24.7, 46.6
                        // If we got the province coordinates, reject them
                        if (bestResult && cityName.toLowerCase() === 'riyadh') {
                            const lat = parseFloat(bestResult.lat);
                            const lng = parseFloat(bestResult.lon);

                            // These are the province coordinates we want to avoid
                            if (Math.abs(lat - 23.333333) < 0.1 && Math.abs(lng - 45.333333) < 0.1) {
                                console.warn('Got Riyadh province coordinates, looking for city...');
                                bestResult = null;

                                // Look for a result closer to the actual city coordinates
                                for (const result of results) {
                                    const resultLat = parseFloat(result.lat);
                                    const resultLng = parseFloat(result.lon);

                                    // Check if coordinates are closer to actual Riyadh city
                                    if (resultLat > 24 && resultLat < 25 && resultLng > 46 && resultLng < 47) {
                                        bestResult = result;
                                        console.log(`Found better Riyadh coordinates: ${result.display_name}`);
                                        break;
                                    }
                                }
                            }
                        }

                        if (bestResult) {
                            const lat = parseFloat(bestResult.lat);
                            const lng = parseFloat(bestResult.lon);
                            console.log(`Final result for ${cityName}: ${bestResult.display_name}`);
                            console.log(`Coordinates: lat=${lat}, lng=${lng}`);
                            console.log(`Type: ${bestResult.type}, Class: ${bestResult.class}, Place Rank: ${bestResult.place_rank}`);

                            return {
                                lat,
                                lng
                            };
                        }
                    }

                    console.warn(`No suitable city results found for ${cityName}`);

                    // As a last resort for major cities, use a more specific search
                    if (['riyadh', 'jeddah', 'Makkah', 'medina', 'dammam'].includes(cityName.toLowerCase())) {
                        console.log('Trying specific search for major city...');
                        const specificQuery = encodeURIComponent(`${cityName} saudi arabia -region -province`);
                        response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${specificQuery}&limit=5&addressdetails=1`);
                        results = await response.json();

                        if (results && results.length > 0) {
                            // Take the first non-administrative result
                            for (const result of results) {
                                if (result.type !== 'administrative' && result.addresstype !== 'state') {
                                    const lat = parseFloat(result.lat);
                                    const lng = parseFloat(result.lon);
                                    console.log(`Specific search found: ${result.display_name} at ${lat}, ${lng}`);
                                    return {
                                        lat,
                                        lng
                                    };
                                }
                            }
                        }
                    }

                    return null;
                } catch (error) {
                    console.error('Geocoding error:', error);
                    return null;
                }
            },

            async searchAvailableStores(lat, lng) {
                try {
                    const productSku = '<?= $escaper->escapeJs($product->getSku()) ?>';
                    console.log('Searching for stores with product:', productSku, 'at location:', lat, lng);

                    const response = await fetch('/stockavailability/store/availability', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: new URLSearchParams({
                            sku: productSku,
                            latitude: lat,
                            longitude: lng,
                            max_distance: 100
                        })
                    });

                    const data = await response.json();
                    console.log('Store availability response:', data);

                    if (data.success) {
                        this.availableStores = data.stores || [];

                        // Sort stores: in_stock first, then by distance
                        this.availableStores.sort((a, b) => {
                            if (a.stock_status === 'in_stock' && b.stock_status !== 'in_stock') return -1;
                            if (a.stock_status !== 'in_stock' && b.stock_status === 'in_stock') return 1;
                            return a.distance - b.distance;
                        });

                        console.log('Found', this.availableStores.length, 'available stores');
                        console.log('In stock:', this.getStoreCountByStatus('in_stock'));
                        console.log('Backorder:', this.getStoreCountByStatus('backorder'));
                    } else {
                        console.error('Store search failed:', data.message);
                        this.availableStores = [];
                    }

                } catch (error) {
                    console.error('Error searching available stores:', error);
                    this.availableStores = [];
                }
            },

            useCurrentLocation() {
                if (navigator.geolocation) {
                    this.isLoading = true;
                    this.searchPerformed = true;
                    this.searchedCity = '<?= $escaper->escapeJs(__('your current location')) ?>';
                    this.loadingMessage = '<?= $escaper->escapeJs(__('Getting your location...')) ?>';

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            console.log('Current location found:', position.coords.latitude, position.coords.longitude);
                            this.loadingMessage = '<?= $escaper->escapeJs(__('Searching for available stores...')) ?>';
                            this.searchAvailableStores(
                                position.coords.latitude,
                                position.coords.longitude
                            );
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            alert('<?= $escaper->escapeJs(__('Unable to get your location. Please select a city from the list above.')) ?>');
                            this.isLoading = false;
                        }, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    alert('<?= $escaper->escapeJs(__('Location services not supported. Please select a city from the list above.')) ?>');
                }
            },

            getDirections(store) {
                const url = `https://www.google.com/maps/dir/?api=1&destination=${store.latitude},${store.longitude}`;
                window.open(url, '_blank');
            }
        };
    }
</script>

<style>
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>