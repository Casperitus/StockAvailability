<?php
/** @var \Madar\StockAvailability\Block\GoogleMaps $block */
$product = $block->getProduct();
if (!$product) {
    return;
}

// Common Saudi cities for quick selection
$commonCities = [
    'Riyadh' => 'Riyadh',
    'Jeddah' => 'Jeddah', 
    'Mecca' => 'Mecca',
    'Medina' => 'Medina',
    'Dammam' => 'Dammam',
    'Khobar' => 'Khobar',
    'Tabuk' => 'Tabuk',
    'Buraidah' => 'Buraidah',
    'Khamis Mushait' => 'Khamis Mushait',
    'Hail' => 'Hail'
];
?>

<div x-data="storeAvailabilityComponent()" x-init="init()" class="store-availability-section border-t pt-6 mt-6">
    <h3 class="text-lg font-semibold mb-4"><?= $escaper->escapeHtml(__('Check availability at stores near you')) ?></h3>
    
    <!-- City Search Input -->
    <div class="mb-4">
        <label for="city-search" class="block text-sm font-medium text-gray-700 mb-2">
            <?= $escaper->escapeHtml(__('Select or enter your city')) ?>
        </label>
        
        <!-- Quick City Buttons -->
        <div class="mb-3 flex flex-wrap gap-2">
            <?php foreach ($commonCities as $arabicName => $englishName): ?>
                <button
                    @click="searchByCity('<?= $escaper->escapeJs($englishName) ?>')"
                    class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-full border"
                    type="button">
                    <?= $escaper->escapeHtml($arabicName) ?>
                </button>
            <?php endforeach; ?>
        </div>
        
        <!-- Manual City Input -->
        <div class="flex gap-2">
            <input
                type="text"
                id="city-search"
                x-ref="cityInput"
                x-model="cityName"
                @keyup.enter="searchByCity(cityName)"
                placeholder="<?= $escaper->escapeHtmlAttr(__('Or type city name (Arabic or English)')) ?>"
                class="flex-1 form-input border border-gray-300 rounded-md px-3 py-2"
            />
            <button
                @click="searchByCity(cityName)"
                :disabled="!cityName.trim() || isLoading"
                class="btn btn-primary px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <?= $escaper->escapeHtml(__('Search')) ?>
            </button>
            <button
                @click="useCurrentLocation()"
                :disabled="isLoading"
                class="btn btn-secondary px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50">
                üìç
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">
            <?= $escaper->escapeHtml(__('Click a city above or type your city name')) ?>
        </p>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="text-center py-6">
        <div class="animate-spin w-6 h-6 border-2 border-gray-300 border-t-blue-600 rounded-full mx-auto mb-2"></div>
        <p class="text-gray-600" x-text="loadingMessage"><?= $escaper->escapeHtml(__('Searching...')) ?></p>
    </div>

    <!-- Search Results Info -->
    <div x-show="searchPerformed && !isLoading && searchedCity" class="mb-4 p-3 bg-blue-50 rounded-lg">
        <p class="text-sm text-blue-800">
            <strong><?= $escaper->escapeHtml(__('Showing stores near:')) ?></strong> 
            <span x-text="searchedCity"></span>
        </p>
    </div>

    <!-- Available Stores List -->
    <div x-show="!isLoading && availableStores.length > 0" class="space-y-3">
        <h4 class="font-medium text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <?= $escaper->escapeHtml(__('Available at these stores')) ?>
            <span class="text-sm font-normal text-gray-600" x-text="'(' + availableStores.length + ' found)'"></span>
        </h4>
        
        <template x-for="store in availableStores" :key="store.source_code">
            <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h5 class="font-medium text-gray-900 mb-1" x-text="store.source_name"></h5>
                        <p class="text-sm text-gray-600 mb-1" x-text="store.address"></p>
                        <p class="text-sm text-gray-600 mb-2" x-show="store.phone">
                            üìû <span x-text="store.phone"></span>
                        </p>
                        <p class="text-sm text-gray-500">
                            üìç <span x-text="store.distance"></span> km away
                        </p>
                    </div>
                    <div class="text-right ml-4">
                        <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mb-2">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <?= $escaper->escapeHtml(__('In Stock')) ?>
                        </div>
                        <div>
                            <button
                                @click="getDirections(store)"
                                class="text-xs text-blue-600 hover:underline">
                                <?= $escaper->escapeHtml(__('Get Directions')) ?>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- No Available Stores Message -->
    <div x-show="!isLoading && searchPerformed && availableStores.length === 0" class="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
        <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
        </svg>
        <p class="text-lg font-medium mb-2"><?= $escaper->escapeHtml(__('No stores found with this product in stock')) ?></p>
        <p class="text-sm">
            <?= $escaper->escapeHtml(__('This product is not available at stores near')) ?> 
            <span x-text="searchedCity" class="font-medium"></span>
        </p>
        <p class="text-xs mt-2"><?= $escaper->escapeHtml(__('Try searching for a different city or check online availability.')) ?></p>
    </div>
</div>

<script>
function storeAvailabilityComponent() {
    return {
        availableStores: [],
        searchPerformed: false,
        isLoading: false,
        cityName: '',
        searchedCity: '',
        loadingMessage: '<?= $escaper->escapeJs(__('Searching...')) ?>',
        
        init() {
            console.log('Store availability component initialized');
        },
        
        async searchByCity(cityName) {
            if (!cityName || !cityName.trim()) {
                alert('<?= $escaper->escapeJs(__('Please enter a city name')) ?>');
                return;
            }
            
            this.isLoading = true;
            this.searchPerformed = true;
            this.availableStores = [];
            this.searchedCity = cityName.trim();
            this.loadingMessage = '<?= $escaper->escapeJs(__('Finding location...')) ?>';
            
            try {
                // First, geocode the city to get coordinates
                const coordinates = await this.geocodeCity(cityName);
                
                if (coordinates) {
                    this.loadingMessage = '<?= $escaper->escapeJs(__('Searching for available stores...')) ?>';
                    await this.searchAvailableStores(coordinates.lat, coordinates.lng);
                } else {
                    this.availableStores = [];
                    alert('<?= $escaper->escapeJs(__('City not found. Please check the spelling and try again.')) ?>');
                }
                
            } catch (error) {
                console.error('Error searching by city:', error);
                this.availableStores = [];
                alert('<?= $escaper->escapeJs(__('Error searching for stores. Please try again.')) ?>');
            } finally {
                this.isLoading = false;
            }
        },
        
        async geocodeCity(cityName) {
            try {
                // Use OpenStreetMap Nominatim API for geocoding
                const query = encodeURIComponent(`${cityName}, Saudi Arabia`);
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1&addressdetails=1`);
                const results = await response.json();
                
                if (results && results.length > 0) {
                    const result = results[0];
                    
                    // Verify it's in Saudi Arabia
                    if (result.address && (
                        result.address.country_code === 'sa' || 
                        result.address.country === 'Saudi Arabia' ||
                        result.display_name.includes('Saudi Arabia')
                    )) {
                        return {
                            lat: parseFloat(result.lat),
                            lng: parseFloat(result.lon)
                        };
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        },
        
        async searchAvailableStores(lat, lng) {
            try {
                const productSku = '<?= $escaper->escapeJs($product->getSku()) ?>';
                console.log('Searching for stores with product:', productSku, 'at location:', lat, lng);
                
                const response = await fetch('/stockavailability/store/availability', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        sku: productSku,
                        latitude: lat,
                        longitude: lng,
                        max_distance: 100 // Increased for city-based search
                    })
                });
                
                const data = await response.json();
                console.log('Store availability response:', data);
                
                if (data.success) {
                    this.availableStores = data.stores || [];
                    console.log('Found', this.availableStores.length, 'available stores');
                } else {
                    console.error('Store search failed:', data.message);
                    this.availableStores = [];
                }
                
            } catch (error) {
                console.error('Error searching available stores:', error);
                this.availableStores = [];
            }
        },
        
        useCurrentLocation() {
            if (navigator.geolocation) {
                this.isLoading = true;
                this.searchPerformed = true;
                this.searchedCity = '<?= $escaper->escapeJs(__('your current location')) ?>';
                this.loadingMessage = '<?= $escaper->escapeJs(__('Getting your location...')) ?>';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('Current location found:', position.coords.latitude, position.coords.longitude);
                        this.loadingMessage = '<?= $escaper->escapeJs(__('Searching for available stores...')) ?>';
                        this.searchAvailableStores(
                            position.coords.latitude,
                            position.coords.longitude
                        );
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('<?= $escaper->escapeJs(__('Unable to get your location. Please select a city from the list above.')) ?>');
                        this.isLoading = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                alert('<?= $escaper->escapeJs(__('Location services not supported. Please select a city from the list above.')) ?>');
            }
        },
        
        getDirections(store) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${store.latitude},${store.longitude}`;
            window.open(url, '_blank');
        }
    };
}
</script>

<style>
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>