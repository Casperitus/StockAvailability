<?php

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\CurrentCategory;
use Hyva\Theme\ViewModel\ProductListItem;
use Hyva\Theme\ViewModel\ProductPage;
use Magento\Catalog\Block\Product\ListProduct;
use Magento\Framework\Escaper;

/** @var ListProduct $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

$productViewModel = $viewModels->require(ProductPage::class);
$productListItemViewModel = $viewModels->require(ProductListItem::class);
$currentCategoryViewModel = $viewModels->require(CurrentCategory::class);
$eagerLoadImagesCount = (int) ($block->getData('eager_load_images_count') ?? 3);
$productCollection = $block->getLoadedProductCollection();
?>

<?php if (!$productCollection->count()): ?>
    <div class="message info empty">
        <div><?= $escaper->escapeHtml(__('We can\'t find products matching the selection.')) ?></div>
    </div>
<?php else: ?>
    <section class="py-8" id="product-list" aria-label="<?= $escaper->escapeHtmlAttr(__('Product list')) ?>" tabindex="-1">
        <?= $block->getToolbarHtml() ?>
        <?= $block->getAdditionalHtml() ?>

        <?php
        if ($block->getMode() === 'grid') {
            $viewMode = 'grid';
            $imageDisplayArea = 'category_page_grid';
            $showDescription = false;
            $templateType = \Magento\Catalog\Block\Product\ReviewRendererInterface::SHORT_VIEW;
        } else {
            $viewMode = 'list';
            $imageDisplayArea = 'category_page_list';
            $showDescription = true;
            $templateType = \Magento\Catalog\Block\Product\ReviewRendererInterface::FULL_VIEW;
        }
        ?>

        <div class="products wrapper mode-<?= $viewMode ?> products-<?= $viewMode ?>">
            <ul role="list" class="mx-auto pt-4 pb-12 grid gap-4 grid-cols-1 <?= $viewMode === 'grid' ? 'sm:grid-cols-2 xl:grid-cols-3' : '' ?>">
                <?php foreach (array_values($productCollection->getItems()) as $i => $product): ?>
                    <?php
                    if ($i < $eagerLoadImagesCount) {
                        $product->setData('image_custom_attributes', ['loading' => 'eager', 'fetchpriority' => 'high']);
                    }

                    $deliverableFlag = $product->getData('is_deliverable_flag');
                    if ($deliverableFlag === null) {
                        $deliverableFlag = $product->getData('is_deliverable');
                    }

                    $isDeliverable = $deliverableFlag === null ? null : (bool)$deliverableFlag;
                    $deliverableLabelData = $product->getData('is_deliverable_label');
                    $deliverableLabel = $deliverableLabelData
                        ? __($deliverableLabelData)
                        : ($isDeliverable ? __('Deliverable') : __('Requestable'));
                    $badgeClasses = $isDeliverable
                        ? 'bg-green-100 text-green-800'
                        : 'bg-yellow-100 text-yellow-800';

                    $itemHtml = $productListItemViewModel->getItemHtml(
                        $product,
                        $block,
                        $viewMode,
                        $templateType,
                        $imageDisplayArea,
                        $showDescription
                    );

                    $skuAttribute = $escaper->escapeHtmlAttr($product->getSku());
                    $itemHtml = preg_replace(
                        '/<li\b([^>]*)>/',
                        '<li$1 data-product-sku="' . $skuAttribute . '">',
                        $itemHtml,
                        1
                    ) ?? $itemHtml;

                    $badgeHtml = sprintf(
                        '<span class="mt-3 inline-flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded %1$s">'
                        . '<span class="w-2 h-2 rounded-full %2$s"></span>%3$s'
                        . '</span>',
                        $badgeClasses,
                        $isDeliverable ? 'bg-green-500' : 'bg-yellow-500',
                        $escaper->escapeHtml($deliverableLabel)
                    );

                    $closingLiPosition = strripos($itemHtml, '</li>');
                    if ($closingLiPosition !== false) {
                        echo substr($itemHtml, 0, $closingLiPosition)
                            . $badgeHtml
                            . substr($itemHtml, $closingLiPosition);
                    } else {
                        echo $itemHtml . $badgeHtml;
                    }
                    ?>
                <?php endforeach; ?>
            </ul>
        </div>
        <?= $block->getChildBlock('toolbar')->setIsBottom(true)->toHtml() ?>
    </section>
<?php endif; ?>
